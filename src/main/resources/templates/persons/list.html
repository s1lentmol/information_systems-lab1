<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <title>Список</title>
  <link rel="stylesheet" type="text/css" href="/static/style/main.css" th:href = "@{/style/main.css}">
</head>
<body>

<div th:replace="~{fragments/nav :: nav}"></div>

<div class="container">
  <div class="page-header">
    <h2>Список</h2>
  </div>

  <div class="card">
    <div class="alert success" th:if="${successMessage}" th:text="${successMessage}"></div>
    <!-- сообщение об ошибке фильтра -->
    <div class="alert error" th:if="${filterError}" th:text="${filterError}"></div>

    <form class="form" method="get" th:action="@{/persons}">
      <div class="row">
        <div class="field">
          <label>Поле фильтра</label>
          <select name="filterField">
            <option value="">без фильтра</option>
            <option value="name" th:selected="${filterField=='name'}">name</option>
            <option value="eyeColor" th:selected="${filterField=='eyeColor'}"
                    th:attr="data-enum=${#strings.arrayJoin(colors, ', ')}">eyeColor</option>
            <option value="hairColor" th:selected="${filterField=='hairColor'}"
                    th:attr="data-enum=${#strings.arrayJoin(colors, ', ')}">hairColor</option>
            <option value="nationality" th:selected="${filterField=='nationality'}"
                    th:attr="data-enum=${#strings.arrayJoin(countries, ', ')}">nationality</option>
          </select>
        </div>

        <div class="field">
          <label>Значение</label>
          <input id="filterValueText" type="text" name="filterValue"
                 th:value="${filterValue}" placeholder="точное совпадение"/>
          <select id="filterValueSelect" class="hidden"></select>
        </div>

        <div class="field">
          <label>Сортировка</label>
          <select name="sort">
            <option value="id" th:selected="${sort=='id'}">id</option>
            <option value="name" th:selected="${sort=='name'}">name</option>
            <option value="height" th:selected="${sort=='height'}">height</option>
            <option value="creationDate" th:selected="${sort=='creationDate'}">creationDate</option>
          </select>
        </div>

        <div class="field">
          <label>Направление</label>
          <select name="dir">
            <option value="asc" th:selected="${dir=='asc'}">asc</option>
            <option value="desc" th:selected="${dir=='desc'}">desc</option>
          </select>
        </div>

        <div class="field" style="align-self:flex-end">
          <button class="btn" type="submit">Применить</button>
        </div>
      </div>
    </form>

    <table>
      <thead>
      <tr>
        <th>ID</th><th>Name</th><th>Height</th><th>Eye</th><th>Hair</th><th>Nationality</th>
        <th>Coord</th><th>Loc</th><th>Created</th><th>Действия</th>
      </tr>
      </thead>
      <tbody>
      <tr th:if="${page.content.isEmpty()}">
        <td colspan="10" class="muted">Нет данных</td>
      </tr>
      <tr th:each="p : ${page.content}">
        <td th:text="${p.id}"></td>
        <td th:text="${p.name}"></td>
        <td th:text="${p.height}"></td>
        <td th:text="${p.eyeColor}"></td>
        <td th:text="${p.hairColor}"></td>
        <td th:text="${p.nationality}"></td>
        <td th:text="${p.coordinates != null ? ('x=' + p.coordinates.x + '; y=' + p.coordinates.y) : ''}"></td>
        <td th:text="${p.location != null ? ('x=' + p.location.x + '; y=' + p.location.y + '; z=' + p.location.z) : ''}"></td>
        <td th:text="${p.creationDateMoscow != null ? #temporals.format(p.creationDateMoscow, 'yyyy-MM-dd HH:mm') : ''}"></td>
        <td>
          <div class="actions">
            <a class="btn ghost" th:href="@{|/persons/${p.id}|}">Открыть</a>
            <a class="btn ghost" th:href="@{|/persons/${p.id}/edit|}">Изм.</a>
            <form class="inline" th:action="@{|/persons/${p.id}/delete|}" method="post"
                  onsubmit="return confirm('Удалить?')">
              <button class="btn danger" type="submit">Удалить</button>
            </form>
          </div>
        </td>
      </tr>
      </tbody>
    </table>

    <div class="pager">
      <span th:text="|Стр. ${page.number + 1} из ${page.totalPages}|"></span>
      <span th:if="${page.hasPrevious()}">
        <a th:href="@{/persons(page=${page.number-1}, size=${page.size}, filterField=${filterField},
            filterValue=${filterValue}, sort=${sort}, dir=${dir})}">&laquo; Назад</a>
      </span>
      <span th:if="${page.hasNext()}">
        <a th:href="@{/persons(page=${page.number+1}, size=${page.size}, filterField=${filterField},
            filterValue=${filterValue}, sort=${sort}, dir=${dir})}">Вперёд &raquo;</a>
      </span>
    </div>
  </div>
</div>

<script th:inline="javascript">
  document.addEventListener('DOMContentLoaded', () => {
    const filterFieldEl = document.querySelector('select[name="filterField"]');
    const textInput = document.getElementById('filterValueText');
    const enumSelect = document.getElementById('filterValueSelect');

    const initialField = /*[[${filterField}]]*/ null;
    const initialValue = /*[[${filterValue}]]*/ null;

    const enumOptions = {};
    Array.from(filterFieldEl.options).forEach(option => {
      const enumPayload = option.getAttribute('data-enum');
      if (option.value && enumPayload) {
        enumOptions[option.value] = enumPayload.split(',').map(item => item.trim()).filter(Boolean);
      }
    });

    const getCurrentValue = () => {
      if (enumSelect.hasAttribute('name')) {
        return enumSelect.value;
      }
      if (textInput.hasAttribute('name')) {
        return textInput.value;
      }
      return '';
    };

    const applyFieldMode = () => {
      const field = filterFieldEl.value;
      const options = enumOptions[field];
      const currentValue = getCurrentValue();

      if (options) {
        enumSelect.innerHTML = '';
        options.forEach(item => {
          const option = document.createElement('option');
          option.value = item;
          option.textContent = item;
          enumSelect.appendChild(option);
        });

        const valueToApply = options.includes(currentValue) ? currentValue : options[0];
        enumSelect.value = valueToApply;

        enumSelect.classList.remove('hidden');
        enumSelect.setAttribute('name', 'filterValue');
        textInput.classList.add('hidden');
        textInput.removeAttribute('name');
      } else {
        textInput.value = currentValue;
        textInput.classList.remove('hidden');
        textInput.setAttribute('name', 'filterValue');
        enumSelect.classList.add('hidden');
        enumSelect.removeAttribute('name');
      }
    };

    if (initialField) {
      filterFieldEl.value = initialField;
    }

    if (initialValue) {
      textInput.value = initialValue;
      enumSelect.value = initialValue;
    }

    applyFieldMode();

    if (enumSelect.hasAttribute('name') && initialValue) {
      const options = enumOptions[filterFieldEl.value] || [];
      if (options.includes(initialValue)) {
        enumSelect.value = initialValue;
      }
    }

    filterFieldEl.addEventListener('change', applyFieldMode);
  });
</script>

<div th:replace="~{fragments/nav :: ws}"></div>
</body>
</html>
